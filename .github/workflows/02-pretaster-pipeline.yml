name: 02 ðŸ”¬ Pretaster Validation

on:
  workflow_dispatch:
    inputs:
      helper_run_id:
        description: 'Helper Prep run ID (leave empty for latest)'
        type: string
        required: false
      test_suite:
        description: 'Test suite to run (all, combo, core, direct)'
        type: string
        required: false
        default: 'all'
  
  workflow_run:
    workflows: ["01 ðŸ¥˜ Helper Prep"]
    types: [completed]
    branches: [main, develop]

jobs:
  setup:
    name: ðŸ”§ Setup & Get Helpers
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      helper_run_id: ${{ steps.helpers.outputs.run_id }}
      test_matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ” Determine version
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: ðŸ” Get Helper prep run
        id: helpers
        run: |
          # Get Helper prep run ID
          if [ -n "${{ inputs.helper_run_id }}" ]; then
            RUN_ID="${{ inputs.helper_run_id }}"
          else
            RUN_ID=$(gh run list --workflow 01-helper-prep.yml --status success --limit 1 --json databaseId -q '.[0].databaseId')
          fi
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: ðŸ§ª Define test matrix
        id: matrix
        run: |
          .github/scripts/create-pretaster-matrix.sh > matrix.json
          MATRIX=$(cat matrix.json | jq -c .)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build-pretaster:
    name: ðŸ”¨ Build Pretaster Packages
    needs: setup
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.test_matrix) }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download helpers for platform
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: 01-helper-prep.yml
          run_id: ${{ needs.setup.outputs.helper_run_id }}
          name: flavor-helpers-${{ needs.setup.outputs.version }}-${{ matrix.platform }}
          path: ./helpers-dist
      
      - name: ðŸ”§ Setup helpers
        shell: bash
        run: |
          # Extract helpers and set up directory structure
          .github/scripts/download-helpers.sh helpers-dist \
            "${{ needs.setup.outputs.version }}" \
            "${{ matrix.platform }}"

          # Helpers are already in helpers/bin/ from the script
          chmod +x helpers/bin/*
          ls -la helpers/bin/
      
      - name: ðŸ”¨ Build Pretaster packages
        working-directory: tests/pretaster
        shell: bash
        run: |
          export FLAVOR_WORKENV_BASE=$(pwd)
          export FLAVOR_LOG_LEVEL=info

          # Create output directory
          mkdir -p dist

          # Build test packages using JSON manifests directly
          echo "ðŸ“¦ Building Pretaster test packages..."

          # Determine binary extension for Windows
          EXT=""
          if [[ "${{ matrix.platform }}" == "windows_"* ]]; then
            EXT=".exe"
          fi

          # Build with different builder/launcher combinations
          ../../helpers/bin/flavor-go-builder-${{ matrix.platform }}${EXT} \
            --manifest configs/test-echo.json \
            --launcher-bin ../../helpers/bin/flavor-rs-launcher-${{ matrix.platform }}${EXT} \
            --output dist/pretaster-echo.psp \
            --key-seed pretaster-test

          ../../helpers/bin/flavor-rs-builder-${{ matrix.platform }}${EXT} \
            --manifest configs/test-shell.json \
            --launcher-bin ../../helpers/bin/flavor-go-launcher-${{ matrix.platform }}${EXT} \
            --output dist/pretaster-shell.psp \
            --key-seed pretaster-test

          ls -la dist/
      
      - name: ðŸ“¤ Upload Pretaster packages
        uses: actions/upload-artifact@v4
        with:
          name: pretaster-packages-${{ needs.setup.outputs.version }}-${{ matrix.platform }}
          path: tests/pretaster/dist/

  test-crosslang:
    name: ðŸ§ª Test Cross-Language Chain
    needs: [setup, build-pretaster, test-pretaster]
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.test_matrix) }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download pretaster packages
        uses: actions/download-artifact@v4
        with:
          name: pretaster-psp-${{ needs.setup.outputs.version }}-${{ matrix.platform }}
          path: ./build
      
      - name: ðŸ“¥ Download helpers for platform
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: 01-helper-prep.yml
          name: flavor-helpers-${{ needs.setup.outputs.version }}-${{ matrix.platform }}
          path: ./helpers-dist
      
      - name: ðŸ” Verify Cross-Language Package
        shell: bash
        run: |
          echo "ðŸ“¦ Checking for pretaster PSP..."

          # Determine PSP extension for Windows
          PSP_EXT=".psp"
          if [[ "${{ matrix.platform }}" == "windows_"* ]]; then
            PSP_EXT=".exe"
          fi

          PRETASTER_PSP="build/pretaster-${{ needs.setup.outputs.version }}-${{ matrix.platform }}${PSP_EXT}"

          if [ -f "$PRETASTER_PSP" ]; then
            echo "âœ… Pretaster package found: $PRETASTER_PSP"
            ls -lh "$PRETASTER_PSP"
          else
            echo "âš ï¸ Pretaster package not found at: $PRETASTER_PSP"
            echo "Contents of build directory:"
            ls -la build/ || echo "Build directory not found"
          fi

      - name: ðŸ§ª Run cross-language tests
        shell: bash
        run: |
          # Determine PSP extension for Windows
          PSP_EXT=".psp"
          if [[ "${{ matrix.platform }}" == "windows_"* ]]; then
            PSP_EXT=".exe"
          fi

          # Set the path to the pretaster PSP (downloaded to ./build)
          PRETASTER_PSP="$(pwd)/build/pretaster-${{ needs.setup.outputs.version }}-${{ matrix.platform }}${PSP_EXT}"

          # Verify the PSP exists
          if [ ! -f "$PRETASTER_PSP" ]; then
            echo "âŒ Pretaster PSP not found at: $PRETASTER_PSP"
            echo "Contents of build directory:"
            ls -la build/ || echo "Build directory not found"
            exit 1
          fi

          chmod +x "$PRETASTER_PSP" 2>/dev/null || true

          # Run tests with the absolute path to the PSP
          # Use "all" as default if test_suite input is not provided (e.g., workflow_run triggers)
          TEST_SUITE="${{ inputs.test_suite }}"
          TEST_SUITE="${TEST_SUITE:-all}"

          .github/scripts/run-pretaster-tests.sh \
            "${{ matrix.platform }}" \
            "${{ needs.setup.outputs.version }}" \
            "$TEST_SUITE" \
            "$PRETASTER_PSP"
      
      - name: ðŸ“¤ Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crosslang-logs-${{ matrix.platform }}-${{ github.run_id }}
          path: tests/pretaster/logs/

      - name: ðŸ“¤ Upload crosslang PSP files
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: crosslang-psp-${{ matrix.platform }}-${{ github.run_id }}
          path: tests/pretaster/dist/*.psp

      - name: ðŸ“¤ Upload failure diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: crosslang-diagnostics-${{ matrix.platform }}-${{ github.run_id }}
          path: tests/pretaster/failure-diagnostics/

  test-pretaster:
    name: ðŸ§ª Build Pretaster ${{ matrix.name }}
    needs: setup
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.test_matrix) }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download helpers for platform
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: 01-helper-prep.yml
          name: flavor-helpers-${{ needs.setup.outputs.version }}-${{ matrix.platform }}
          path: ./helpers-dist
      
      - name: ðŸ”§ Build pretaster PSP
        shell: bash
        run: |
          # The dawidd6 action downloads the artifact contents (zip files) to helpers-dist/
          echo "Contents of helpers-dist:"
          ls -la helpers-dist/ || true
          
          # Extract the helper binaries
          .github/scripts/download-helpers.sh helpers-dist \
            "${{ needs.setup.outputs.version }}" \
            "${{ matrix.platform }}"
          
          # Build pretaster PSP using the consolidated script
          mkdir -p build
          .github/scripts/build-pretaster.sh \
            "${{ matrix.platform }}" \
            "${{ needs.setup.outputs.version }}" \
            "simple" \
            "build"
      
      - name: ðŸ“¤ Upload pretaster PSP
        uses: actions/upload-artifact@v4
        with:
          name: pretaster-psp-${{ needs.setup.outputs.version }}-${{ matrix.platform }}
          path: build/pretaster-${{ needs.setup.outputs.version }}-${{ matrix.platform }}.*
      
      - name: ðŸ“¤ Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pretaster-logs-${{ matrix.platform }}-${{ github.run_id }}
          path: tests/pretaster/logs/

      - name: ðŸ“¤ Upload failure diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-diagnostics-${{ matrix.platform }}-${{ github.run_id }}
          path: tests/pretaster/failure-diagnostics/

  validate:
    name: âœ… Validate PSPF Compatibility
    needs: [setup, test-pretaster, test-crosslang]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download all logs
        uses: actions/download-artifact@v4
        with:
          pattern: '*-logs-*'
          path: all-logs
      
      - name: ðŸ“Š Generate compatibility report
        run: |
          .github/scripts/generate-pspf-compatibility-report.sh all-logs