name: 05 ðŸŽ¨ Code Quality

on:
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output'
        type: boolean
        required: false
        default: false
      skip_cache:
        description: 'Skip cache restoration'
        type: boolean
        required: false
        default: false
  
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.py'
      - '**.go'
      - '**.rs'
      - 'pyproject.toml'
      - 'go.mod'
      - 'Cargo.toml'
      - '.github/workflows/05-code-quality.yml'
  
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

concurrency:
  group: quality-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Python Code Quality
  python-quality:
    name: ðŸ Python Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install Quality Tools
        run: |
          python -m venv quality-env
          source quality-env/bin/activate
          pip install --upgrade pip
          pip install \
            ruff \
            mypy \
            bandit[toml] \
            pylint \
            black \
            isort \
            flake8 \
            flake8-docstrings \
            flake8-bugbear \
            flake8-comprehensions \
            flake8-simplify \
            pydocstyle \
            pycodestyle \
            mccabe \
            radon \
            xenon \
            vulture \
            safety \
            pip-audit
          
          # Install project dependencies for better type checking
          pip install -e ".[dev,test]"
      
      - name: ðŸŽ¨ Code Formatting Check
        id: formatting
        continue-on-error: true
        run: |
          source quality-env/bin/activate
          echo "## ðŸŽ¨ Code Formatting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Black formatting
          echo "### Black Formatting" >> $GITHUB_STEP_SUMMARY
          if black --check --diff src/ src/ tests/ 2>&1 | tee black.log; then
            echo "âœ… Black formatting passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Black formatting issues found" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            cat black.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # isort import sorting
          echo "### Import Sorting" >> $GITHUB_STEP_SUMMARY
          if isort --check-only --diff src/ src/ tests/ 2>&1 | tee isort.log; then
            echo "âœ… Import sorting passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Import sorting issues found" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            cat isort.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ” Linting Analysis
        id: linting
        continue-on-error: true
        run: |
          source quality-env/bin/activate
          echo "## ðŸ” Linting Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Ruff - Fast Python linter
          echo "### Ruff Analysis" >> $GITHUB_STEP_SUMMARY
          ruff check src/ src/ tests/ --statistics --output-format=json > ruff.json || true
          ruff check src/ src/ tests/ --statistics 2>&1 | tee ruff.log || true
          
          if [ -s ruff.log ]; then
            echo "âš ï¸ Ruff found issues:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat ruff.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Ruff analysis passed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Pylint - Comprehensive linter
          echo "### Pylint Analysis" >> $GITHUB_STEP_SUMMARY
          pylint src/ --output-format=json > pylint.json 2>/dev/null || true
          pylint src/ --score=y 2>&1 | tail -20 | tee pylint.log || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat pylint.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Flake8 with plugins
          echo "### Flake8 Analysis" >> $GITHUB_STEP_SUMMARY
          flake8 src/ src/ tests/ \
            --count \
            --statistics \
            --max-line-length=100 \
            --max-complexity=10 \
            --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s' \
            2>&1 | tee flake8.log || true
          
          if [ -s flake8.log ]; then
            ISSUE_COUNT=$(grep -c ":" flake8.log || echo "0")
            echo "âš ï¸ Flake8 found $ISSUE_COUNT issues" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 flake8.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Flake8 analysis passed" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ”’ Type Checking
        id: type-checking
        continue-on-error: true
        run: |
          source quality-env/bin/activate
          echo "## ðŸ”’ Type Checking" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # MyPy type checking
          echo "### MyPy Type Analysis" >> $GITHUB_STEP_SUMMARY
          mypy src/ \
            --ignore-missing-imports \
            --no-error-summary \
            --show-error-codes \
            --show-column-numbers \
            --pretty \
            --html-report mypy-report \
            --txt-report mypy-txt \
            2>&1 | tee mypy.log || true
          
          if grep -q "error:" mypy.log; then
            ERROR_COUNT=$(grep -c "error:" mypy.log)
            echo "âŒ MyPy found $ERROR_COUNT type errors" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep "error:" mypy.log | head -30 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… MyPy type checking passed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Generate type coverage report
          echo "### Type Coverage" >> $GITHUB_STEP_SUMMARY
          if [ -f mypy-txt/index.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -10 mypy-txt/index.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“Š Complexity Analysis
        id: complexity
        continue-on-error: true
        run: |
          source quality-env/bin/activate
          echo "## ðŸ“Š Code Complexity" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Radon - Cyclomatic Complexity
          echo "### Cyclomatic Complexity (Radon)" >> $GITHUB_STEP_SUMMARY
          radon cc src/ -s -j > radon-cc.json || true
          radon cc src/ -s --total-average 2>&1 | tee radon.log || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 radon.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Radon - Maintainability Index
          echo "### Maintainability Index" >> $GITHUB_STEP_SUMMARY
          radon mi src/ -s 2>&1 | tee radon-mi.log || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -E "^[A-F]" radon-mi.log | head -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Xenon - Complexity monitoring
          echo "### Complexity Violations (Xenon)" >> $GITHUB_STEP_SUMMARY
          if xenon src/ --max-absolute B --max-modules B --max-average A 2>&1 | tee xenon.log; then
            echo "âœ… Complexity within acceptable limits" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ High complexity detected:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat xenon.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # McCabe complexity
          echo "### McCabe Complexity" >> $GITHUB_STEP_SUMMARY
          python -m mccabe --min 10 src/**/*.py 2>&1 | tee mccabe.log || true
          if [ -s mccabe.log ]; then
            echo "âš ï¸ Functions with complexity > 10:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat mccabe.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All functions have acceptable complexity" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“ Documentation Quality
        id: documentation
        continue-on-error: true
        run: |
          source quality-env/bin/activate
          echo "## ðŸ“ Documentation Quality" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Pydocstyle - Docstring conventions
          echo "### Docstring Conventions" >> $GITHUB_STEP_SUMMARY
          pydocstyle src/ --count 2>&1 | tee pydocstyle.log || true
          
          if grep -q "violations" pydocstyle.log; then
            VIOLATIONS=$(grep "violations" pydocstyle.log)
            echo "âš ï¸ $VIOLATIONS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -30 pydocstyle.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Documentation conventions followed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for missing docstrings
          echo "### Missing Docstrings" >> $GITHUB_STEP_SUMMARY
          python -c "
          import ast
          import os
          from pathlib import Path
          
          missing = []
          for py_file in Path('src').rglob('*.py'):
              with open(py_file) as f:
                  try:
                      tree = ast.parse(f.read())
                      for node in ast.walk(tree):
                          if isinstance(node, (ast.FunctionDef, ast.ClassDef)):
                              if not ast.get_docstring(node):
                                  missing.append(f'{py_file}:{node.lineno} - {node.name}')
                  except: pass
          
          if missing:
              print(f'Found {len(missing)} functions/classes without docstrings')
              for m in missing[:20]:
                  print(f'  - {m}')
          else:
              print('All functions and classes have docstrings')
          " | tee docstring-check.log
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat docstring-check.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ§¹ Dead Code Detection
        id: dead-code
        continue-on-error: true
        run: |
          source quality-env/bin/activate
          echo "## ðŸ§¹ Dead Code Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Vulture - Find dead code
          echo "### Unused Code (Vulture)" >> $GITHUB_STEP_SUMMARY
          vulture src/ src/ --min-confidence 80 2>&1 | tee vulture.log || true
          
          DEAD_CODE_COUNT=$(wc -l < vulture.log)
          if [ "$DEAD_CODE_COUNT" -gt 0 ]; then
            echo "âš ï¸ Found $DEAD_CODE_COUNT potential dead code items" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 vulture.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No dead code detected" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“ˆ Generate Quality Metrics
        if: always()
        run: |
          source quality-env/bin/activate
          echo "## ðŸ“ˆ Quality Metrics Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count total issues
          TOTAL_ISSUES=0
          
          # Formatting issues - ensure single line values
          BLACK_ISSUES=$(grep -c "would reformat" black.log 2>/dev/null || echo 0)
          BLACK_ISSUES=${BLACK_ISSUES//[^0-9]/}
          [ -z "$BLACK_ISSUES" ] && BLACK_ISSUES=0
          
          ISORT_ISSUES=$(grep -c "ERROR" isort.log 2>/dev/null || echo 0)
          ISORT_ISSUES=${ISORT_ISSUES//[^0-9]/}
          [ -z "$ISORT_ISSUES" ] && ISORT_ISSUES=0
          
          # Linting issues - ensure single line values
          RUFF_ISSUES=$(grep -c ":" ruff.log 2>/dev/null || echo 0)
          RUFF_ISSUES=${RUFF_ISSUES//[^0-9]/}
          [ -z "$RUFF_ISSUES" ] && RUFF_ISSUES=0
          
          FLAKE8_ISSUES=$(grep -c ":" flake8.log 2>/dev/null || echo 0)
          FLAKE8_ISSUES=${FLAKE8_ISSUES//[^0-9]/}
          [ -z "$FLAKE8_ISSUES" ] && FLAKE8_ISSUES=0
          
          # Type issues - ensure single line values
          MYPY_ISSUES=$(grep -c "error:" mypy.log 2>/dev/null || echo 0)
          MYPY_ISSUES=${MYPY_ISSUES//[^0-9]/}
          [ -z "$MYPY_ISSUES" ] && MYPY_ISSUES=0
          
          # Documentation issues - ensure single line values
          DOC_ISSUES=$(grep -c ":" pydocstyle.log 2>/dev/null || echo 0)
          DOC_ISSUES=${DOC_ISSUES//[^0-9]/}
          [ -z "$DOC_ISSUES" ] && DOC_ISSUES=0
          
          # Dead code - ensure single line values
          DEAD_CODE=$(wc -l < vulture.log 2>/dev/null || echo 0)
          DEAD_CODE=${DEAD_CODE//[^0-9]/}
          [ -z "$DEAD_CODE" ] && DEAD_CODE=0
          
          TOTAL_ISSUES=$((BLACK_ISSUES + ISORT_ISSUES + RUFF_ISSUES + FLAKE8_ISSUES + MYPY_ISSUES + DOC_ISSUES + DEAD_CODE))
          
          echo "| Category | Issues | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Formatting (Black) | $BLACK_ISSUES | $([ $BLACK_ISSUES -eq 0 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
          echo "| Import Sorting | $ISORT_ISSUES | $([ $ISORT_ISSUES -eq 0 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
          echo "| Ruff Linting | $RUFF_ISSUES | $([ $RUFF_ISSUES -eq 0 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
          echo "| Flake8 Linting | $FLAKE8_ISSUES | $([ $FLAKE8_ISSUES -lt 10 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Checking | $MYPY_ISSUES | $([ $MYPY_ISSUES -eq 0 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | $DOC_ISSUES | $([ $DOC_ISSUES -lt 50 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
          echo "| Dead Code | $DEAD_CODE | $([ $DEAD_CODE -lt 20 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$TOTAL_ISSUES** | $([ $TOTAL_ISSUES -lt 100 ] && echo 'âœ…' || echo 'âŒ') |" >> $GITHUB_STEP_SUMMARY
          
          # Create JSON report
          cat > quality-report.json << EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "metrics": {
              "formatting": {
                "black": $BLACK_ISSUES,
                "isort": $ISORT_ISSUES
              },
              "linting": {
                "ruff": $RUFF_ISSUES,
                "flake8": $FLAKE8_ISSUES
              },
              "type_checking": {
                "mypy": $MYPY_ISSUES
              },
              "documentation": {
                "pydocstyle": $DOC_ISSUES
              },
              "dead_code": {
                "vulture": $DEAD_CODE
              },
              "total_issues": $TOTAL_ISSUES
            }
          }
          EOF
      
      - name: ðŸ“¤ Upload Quality Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-quality-reports
          path: |
            *.log
            *.json
            mypy-report/
            mypy-txt/
            quality-report.json

  # Go Code Quality
  go-quality:
    name: ðŸ¹ Go Quality
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "${{ vars.GO_VERSION }}"
          cache: true
          cache-dependency-path: |
            src/flavor-go/go.sum
      
      - name: ðŸ“¦ Install Go Quality Tools
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          go install golang.org/x/tools/cmd/goimports@latest
          go install honnef.co/go/tools/cmd/staticcheck@latest
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          go install github.com/go-critic/go-critic/cmd/gocritic@latest
          go install github.com/jgautheron/goconst/cmd/goconst@latest
          go install github.com/kisielk/errcheck@latest
          go install github.com/mdempsky/unconvert@latest
          go install github.com/gordonklaus/ineffassign@latest
          go install github.com/fzipp/gocyclo/cmd/gocyclo@latest
          go install github.com/client9/misspell/cmd/misspell@latest
      
      - name: ðŸ” Go Linting
        continue-on-error: true
        run: |
          cd src/flavor-go
          echo "## ðŸ¹ Go Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # golangci-lint
          echo "### GolangCI-Lint Analysis" >> $GITHUB_STEP_SUMMARY
          if golangci-lint run --out-format=json > golangci.json 2>&1; then
            echo "âœ… GolangCI-Lint passed" >> $GITHUB_STEP_SUMMARY
          else
            golangci-lint run 2>&1 | tee golangci.log || true
            echo "âš ï¸ GolangCI-Lint found issues:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 golangci.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # Static check
          echo "### Static Analysis" >> $GITHUB_STEP_SUMMARY
          if staticcheck ./... 2>&1 | tee staticcheck.log; then
            echo "âœ… Staticcheck passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Staticcheck found issues:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat staticcheck.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # Go vet
          echo "### Go Vet" >> $GITHUB_STEP_SUMMARY
          if go vet ./... 2>&1 | tee govet.log; then
            echo "âœ… Go vet passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Go vet found issues:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat govet.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # Cyclomatic complexity
          echo "### Cyclomatic Complexity" >> $GITHUB_STEP_SUMMARY
          gocyclo -over 10 . 2>&1 | tee gocyclo.log || true
          if [ -s gocyclo.log ]; then
            echo "âš ï¸ High complexity functions:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat gocyclo.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All functions have acceptable complexity" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“¤ Upload Go Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: go-quality-reports
          path: |
            src/flavor-go/*.log
            src/flavor-go/*.json

  # Rust Code Quality
  rust-quality:
    name: ðŸ¦€ Rust Quality
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Rust Toolchain with Cache
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
          cache: true

      - name: ðŸ“¦ Cache Rust Quality Tools
        uses: actions/cache@v4
        id: cache-rust-tools
        with:
          path: |
            ~/.cargo/bin/cargo-audit
            ~/.cargo/bin/cargo-outdated
            ~/.cargo/bin/cargo-machete
            ~/.cargo/bin/cargo-deny
            ~/.cargo/bin/cargo-geiger
          key: rust-tools-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}-v1
          restore-keys: |
            rust-tools-${{ runner.os }}-v1

      - name: ðŸ“¦ Install Rust Quality Tools
        if: steps.cache-rust-tools.outputs.cache-hit != 'true'
        run: |
          # Use cargo-binstall for faster installation when possible
          cargo install cargo-binstall --quiet || true

          # Try binstall first, fallback to cargo install
          cargo binstall --no-confirm cargo-audit || cargo install cargo-audit --quiet
          cargo binstall --no-confirm cargo-outdated || cargo install cargo-outdated --quiet
          cargo binstall --no-confirm cargo-machete || cargo install cargo-machete --quiet
          cargo binstall --no-confirm cargo-deny || cargo install cargo-deny --quiet
          cargo binstall --no-confirm cargo-geiger || cargo install cargo-geiger --quiet
      
      - name: ðŸ” Rust Linting
        continue-on-error: true
        run: |
          cd src/flavor-rs
          echo "## ðŸ¦€ Rust Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Clippy
          echo "### Clippy Analysis" >> $GITHUB_STEP_SUMMARY
          if cargo clippy -- -D warnings 2>&1 | tee clippy.log; then
            echo "âœ… Clippy passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Clippy found issues:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat clippy.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # Rustfmt
          echo "### Format Check" >> $GITHUB_STEP_SUMMARY
          if cargo fmt -- --check 2>&1 | tee rustfmt.log; then
            echo "âœ… Formatting correct" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Formatting issues found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat rustfmt.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # Unused dependencies
          echo "### Unused Dependencies" >> $GITHUB_STEP_SUMMARY
          if cargo machete 2>&1 | tee machete.log; then
            echo "âœ… No unused dependencies" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Unused dependencies found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat machete.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“¤ Upload Rust Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rust-quality-reports
          path: |
            src/flavor-rs/*.log

  # Aggregate Quality Report
  quality-report:
    name: ðŸ“Š Quality Report
    needs: [python-quality, go-quality, rust-quality]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Download all reports
        uses: actions/download-artifact@v4
        with:
          path: quality-reports
      
      - name: ðŸ“Š Generate Final Report
        run: |
          echo "# ðŸŽ¨ Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Language Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check each language status
          echo "| Language | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "quality-reports/python-quality-reports" ]; then
            if [ -f "quality-reports/python-quality-reports/quality-report.json" ]; then
              TOTAL=$(jq -r '.metrics.total_issues' quality-reports/python-quality-reports/quality-report.json)
              echo "| ðŸ Python | $([ $TOTAL -lt 100 ] && echo 'âœ…' || echo 'âš ï¸') | $TOTAL issues |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ðŸ Python | âŒ | Report generation failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| ðŸ Python | â­ï¸ | Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "quality-reports/go-quality-reports" ]; then
            echo "| ðŸ¹ Go | âœ… | Analysis complete |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ¹ Go | â­ï¸ | Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "quality-reports/rust-quality-reports" ]; then
            echo "| ðŸ¦€ Rust | âœ… | Analysis complete |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ¦€ Rust | â­ï¸ | Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the detailed reports in each job" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix critical issues first (type errors, security issues)" >> $GITHUB_STEP_SUMMARY
          echo "3. Address formatting and style issues" >> $GITHUB_STEP_SUMMARY
          echo "4. Consider refactoring high-complexity code" >> $GITHUB_STEP_SUMMARY
          echo "5. Add missing documentation" >> $GITHUB_STEP_SUMMARY